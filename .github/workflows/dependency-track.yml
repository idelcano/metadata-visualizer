name: dependency-track

on:
    push:
        branches: ["main"]
    pull_request:

jobs:
    bom:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "yarn"

            - name: Enable corepack
              run: corepack enable

            - name: Install dependencies
              run: yarn install --immutable

            - name: Generate BOM
              run: yarn dlx -q @cyclonedx/yarn-plugin-cyclonedx --output-file bom.json --output-format JSON

            - name: Upload BOM to Dependency-Track
              env:
                  DTRACK_URL: ${{ secrets.DTRACK_URL }}
                  DTRACK_API_KEY: ${{ secrets.DTRACK_API_KEY }}
              run: |
                  set -euo pipefail
                  PROJECT_NAME=$(node -p "require('./package.json').name")
                  PROJECT_VERSION=$(node -p "require('./package.json').version")
                  curl -X POST "${DTRACK_URL}/api/v1/bom" \
                    -H "X-Api-Key: ${DTRACK_API_KEY}" \
                    -F "autoCreate=true" \
                    -F "projectName=${PROJECT_NAME}" \
                    -F "projectVersion=${PROJECT_VERSION}" \
                    -F "bom=@${PWD}/bom.json;type=application/json"
